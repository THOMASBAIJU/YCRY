{% extends "base.html" %}

{% block content %}
<div class="assistant-container">
    <div class="split-layout">
        
        <!-- LEFT: Chat Interface -->
        <div class="chat-section">
            <div class="ai-header-left">
                <h1>Dr. Ycry</h1>
                <p>Your AI Pediatric Companion</p>
            </div>

            <div class="chat-wrapper">
                <div class="chat-log" id="chat-log">
                    <!-- Initial Message with Avatar -->
                    <div class="msg-row bot">
                        <div class="msg-avatar">
                            <img src="{{ url_for('static', filename='images/ai_feature.png') }}" alt="Bot">
                        </div>
                        <div class="msg">
                            Hi {{ session['real_name'] }}! I'm here for you.<br>How is the baby?
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <input type="text" id="text-input" placeholder="Type a message..." onkeypress="handleKey(event)">
                    <button onclick="sendText()">‚û§</button>
                </div>
            </div>
        </div>

        <!-- RIGHT: Avatar & Controls -->
        <div class="avatar-section-right">
            <!-- Avatar (Clickable) -->
            <div class="avatar-circle-large" id="avatar" onclick="toggleListening()" style="cursor: pointer;" title="Click to Talk">
                <img src="{{ url_for('static', filename='images/ai_feature.png') }}" alt="Dr. Ycry" class="avatar-img">
            </div>
            
            <div class="status-container">
                <p id="status-text">Tap Dr YCRY to talk...</p>
                <div id="wave-animation" class="hidden">
                    <span>.</span><span>.</span><span>.</span>
                </div>
            </div>

            <!-- Quick Action Chips -->
            <div class="quick-chips-grid">
                <button class="chip" onclick="sendChip('üçº Feeding Tips')">üçº Feeding</button>
                <button class="chip" onclick="sendChip('üò¥ Sleep Help')">üò¥ Sleep</button>
                <button class="chip" onclick="sendChip('üíâ Vaccine Schedule')">üíâ Vaccines</button>
                <button class="chip" onclick="sendChip('ü§í Fever Help')">ü§í Fever</button>
            </div>

            <!-- Controls Removed as per user request -->
        </div>

    </div>
</div>

<style>
    .assistant-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Split Layout */
    .split-layout {
        display: flex;
        gap: 40px;
        align-items: flex-start; /* Align top */
    }

    /* Quick Chips */
    .quick-chips-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        width: 100%;
        max-width: 300px;
    }
    .chip {
        background: white;
        border: 1px solid #eee;
        border-radius: 25px;
        padding: 10px 15px;
        font-size: 0.9rem;
        color: #555;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        font-weight: 600;
    }
    .chip:hover {
        background: #FF6B6B;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(255, 107, 107, 0.2);
        border-color: #FF6B6B;
    }

    /* Msg Row for Avatars */
    .msg-row {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        max-width: 80%;
    }
    .msg-row.user { align-self: flex-end; flex-direction: row-reverse; }
    .msg-row.bot { align-self: flex-start; }

    .msg-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
        border: 2px solid white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .msg-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    
    .msg { 
        padding: 12px 18px; 
        border-radius: 18px; 
        line-height: 1.5; 
        font-size: 0.95rem;
        position: relative;
    }
    .msg-row.user .msg { 
        background: #4ECDC4; /* Teal for User */
        color: white; 
        border-bottom-right-radius: 4px; 
        box-shadow: 0 4px 15px rgba(78, 205, 196, 0.2);
    }
    .msg-row.bot .msg { 
        background: white; 
        color: #444; 
        border: 1px solid #eee; 
        border-bottom-left-radius: 4px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    }

    /* Left Column: Chat */
    .chat-section {
        flex: 1.2; /* Takes 60% approx */
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.05);
        border: 1px solid rgba(255,255,255,0.8);
    }

    .ai-header-left h1 {
        font-size: 2rem;
        color: #FF6B6B;
        margin-bottom: 5px;
        text-align: left;
    }
    .ai-header-left p {
        text-align: left;
        color: #888;
        margin-bottom: 20px;
    }

    /* Chat Area Updates */
    .chat-wrapper {
        margin-top: 0;
        border: 1px solid #f0f0f0;
        border-radius: 15px;
        box-shadow: none; /* Remove duplicate shadow */
    }
    .chat-log {
        height: 500px; /* Taller chat */
        background: #fdfdfd;
    }

    /* Right Column: Avatar */
    .avatar-section-right {
        flex: 0.8; /* Takes 40% approx */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding-top: 40px;
        position: sticky;
        top: 20px;
    }

    /* Large Avatar */
    .avatar-circle-large {
        width: 250px;
        height: 250px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 20px 50px rgba(0,0,0,0.1);
        transition: transform 0.3s, box-shadow 0.3s;
        overflow: hidden;
        border: 6px solid white;
        position: relative;
        margin-bottom: 30px;
        animation: breathe 3s infinite ease-in-out; /* Idle Animation */
    }

    .avatar-circle-large:hover {
        transform: scale(1.05); /* Hover effect */
        border-color: #FFECEC;
    }

    .avatar-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scale(1.1);
    }

    /* Status & Controls */
    .status-container {
        min-height: 40px;
        margin-bottom: 30px;
        text-align: center;
    }
    #status-text {
        font-size: 1.1rem;
        color: #555;
        font-weight: 600;
    }

    /* Avatar States (Updated classes) */
    .avatar-circle-large.listening {
        animation: pulse-green 1.5s infinite;
        border-color: #4ECDC4;
    }
    .avatar-circle-large.waiting {
        animation: pulse-yellow 2s infinite;
        border-color: #FFD93D;
    }
    .avatar-circle-large.speaking {
        animation: bounce-talk 0.5s infinite alternate;
        border-color: #FF6B6B;
        box-shadow: 0 0 30px rgba(255, 107, 107, 0.5);
    }

    /* Reuse Animations */
    @keyframes breathe {
        0% { transform: scale(1); box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
        50% { transform: scale(1.02); box-shadow: 0 25px 60px rgba(0,0,0,0.15); }
        100% { transform: scale(1); box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
    }

    @keyframes pulse-green {
        0% { box-shadow: 0 0 0 0 rgba(78, 205, 196, 0.7); transform: scale(1); }
        70% { box-shadow: 0 0 0 30px rgba(78, 205, 196, 0); transform: scale(1.02); }
        100% { box-shadow: 0 0 0 0 rgba(78, 205, 196, 0); transform: scale(1); }
    }
    @keyframes pulse-yellow {
        0% { box-shadow: 0 0 0 0 rgba(255, 217, 61, 0.7); transform: scale(1); }
        70% { box-shadow: 0 0 0 30px rgba(255, 217, 61, 0); transform: scale(1.02); }
        100% { box-shadow: 0 0 0 0 rgba(255, 217, 61, 0); transform: scale(1); }
    }
    @keyframes bounce-talk {
        from { transform: scale(1); border-color: #FF6B6B; }
        to { transform: scale(1.05); border-color: #FF8E53; }
    }

    /* Responsive: Stack on Mobile */
    @media (max-width: 900px) {
        .split-layout {
            flex-direction: column-reverse; /* Chat on bottom, Avatar on top */
            align-items: center;
        }
        .chat-section, .avatar-section-right {
            flex: none;
            width: 100%;
        }
        .chat-log { height: 350px; }
        .avatar-circle-large { width: 180px; height: 180px; }
    }


    /* Chat Area */
    .chat-wrapper {
        margin-top: 30px;
        background: white;
        border-radius: 15px;
        border: 1px solid #eee;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }

    .chat-log {
        padding: 20px;
        height: 300px;
        overflow-y: auto;
        text-align: left;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* .msg removed - replaced by .msg-row logic */

    .input-area {
        display: flex;
        padding: 10px;
        background: white;
        border-top: 1px solid #eee;
    }
    .input-area input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 20px;
        outline: none;
    }
    .input-area button {
        background: none;
        border: none;
        color: #FF6B6B;
        font-size: 20px;
        margin-left: 10px;
        cursor: pointer;
    }
</style>

<script>
    // --- VARIABLES ---
    const avatar = document.getElementById('avatar');
    const statusText = document.getElementById('status-text');
    const chatLog = document.getElementById('chat-log');
    
    // User Avatar URL (passed from Flask)
    // If empty, we use default icon
    const userPic = "{{ navbar_pic }}";
    const userAvatarUrl = userPic ? "{{ url_for('static', filename='profile_pics/') }}" + userPic : "";

    // --- SOUND EFFECTS ---
    // Soft "Ping" (Base64 WAV)
    const soundStart = new Audio("data:audio/wav;base64,UklGRjoAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ4AAACAgICAgICAgICAgICAgIA=");
    
    /* 
       Note: Real audio files would be better, but we use this silent/short buffer 
       to just initialize the Audio object logic. 
       For now, we rely on the visual "Pulse" and the Robot's voice as feedback.
    */
    
    let recognition;
    let isSpeaking = false;
    let isListening = false;
    let shouldRestart = false; 
    let silenceTimer = null;
    let speechBuffer = ""; 

    // --- QUICK CHIPS ---
    function sendChip(text) {
        // Play click sound (optional, reusing start sound)
        try { soundStart.play(); } catch(e){}
        
        addMessage(text, 'user');
        
        // Stop listening if active
        if(isListening) {
            shouldRestart = true;
            recognition.stop();
        }
        sendToAI(text);
    }

    // --- SETUP VOICE ---
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true; 
        recognition.lang = 'en-IN'; 
        recognition.interimResults = false;

        recognition.onstart = function() {
            isListening = true;
            avatar.classList.add('listening');
            avatar.classList.remove('waiting');
            statusText.textContent = "Listening...";
            try { soundStart.play(); } catch(e){}
        };

        recognition.onend = function() {
            isListening = false;
            avatar.classList.remove('listening');
            avatar.classList.remove('waiting');
            
            // Hardcoded Continuous Loop (Stop only if user clicks again)
            if (shouldRestart && !isSpeaking) {
                statusText.textContent = "Resuming loop...";
                setTimeout(startRecognition, 100); 
            } else if (!shouldRestart) {
                statusText.textContent = "Tap Dr YCRY to talk";
            }
        };

        recognition.onresult = function(event) {
            const currentObj = event.results[event.results.length - 1];
            const transcript = currentObj[0].transcript;
            
            if (currentObj.isFinal) {
                speechBuffer += transcript + ". ";
                statusText.textContent = "Hearing you...";
                avatar.classList.remove('listening');
                avatar.classList.add('waiting'); 
                
                clearTimeout(silenceTimer);
                silenceTimer = setTimeout(() => {
                    finishUserSpeech();
                }, 2500);
            }
        };
        
        recognition.onerror = function(event) {
            if(event.error === 'no-speech') return; 
            statusText.textContent = "Error: " + event.error;
        };

    } else {
        alert("Voice not supported. Try Chrome.");
    }

    function toggleListening() {
        if (isListening) {
             shouldRestart = false; // User explicitly stopped it
             recognition.stop();
             clearTimeout(silenceTimer);
        } else {
             startRecognition();
        }
    }

    function startRecognition() {
        if (isSpeaking) return;
        try {
            speechBuffer = ""; 
            recognition.start();
            shouldRestart = true;
        } catch(e) {}
    }

    function finishUserSpeech() {
        shouldRestart = false; // Pause loop to process
        recognition.stop();
        
        if (speechBuffer.trim().length > 0) {
            const finalTxt = speechBuffer.trim();
            addMessage(finalTxt, 'user');
            sendToAI(finalTxt);
        }
        speechBuffer = "";
    }

    // --- TEXT INPUT ---
    function handleKey(e) { if(e.key === 'Enter') sendText(); }
    
    function sendText() {
        const input = document.getElementById('text-input');
        const text = input.value.trim();
        if(!text) return;
        
        input.value = '';
        addMessage(text, 'user');
        
        if (isListening) {
            shouldRestart = true; 
            recognition.stop();
        }
        sendToAI(text);
    }

    // --- AI LOGIC ---
    async function sendToAI(text) {
        statusText.textContent = "Thinking...";
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: text })
            });
            const data = await response.json();
            
            if (data.response) {
                addMessage(data.response, 'bot');
                statusText.textContent = "Replying...";
                
                // Always talk back now
                speak(data.response);
            } else if (data.error) {
                // Handle Backend Error (e.g. API Key invalid)
                statusText.textContent = "Error: " + data.error;
                addMessage("‚ö†Ô∏è Error: " + data.error, 'bot');
            }
        } catch (e) {
            statusText.textContent = "Error: " + e;
            addMessage("‚ö†Ô∏è System Error: Check console.", 'bot');
        }
    }

    function addMessage(text, sender) {
        // Create Row
        const row = document.createElement('div');
        row.classList.add('msg-row', sender);
        
        // Avatar
        const avatarDiv = document.createElement('div');
        avatarDiv.classList.add('msg-avatar');
        
        const img = document.createElement('img');
        if (sender === 'bot') {
            img.src = "{{ url_for('static', filename='images/ai_feature.png') }}";
            avatarDiv.appendChild(img);
        } else {
            // User Avatar Logic
            if (userAvatarUrl) {
                img.src = userAvatarUrl;
                avatarDiv.appendChild(img);
            } else {
               // Default User Icon text if no image
               avatarDiv.textContent = "üë§"; 
               avatarDiv.style.background = "#fff";
            }
        }
        
        // Message Bubble
        const bubble = document.createElement('div');
        bubble.classList.add('msg');
        bubble.textContent = text;
        
        // Assemble
        row.appendChild(avatarDiv);
        row.appendChild(bubble);
        
        chatLog.appendChild(row);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // --- SPEECH OUTPUT ---
    function speak(text) {
        window.speechSynthesis.cancel();
        
        // Make global to prevent Garbage Collection (Common Chrome Bug)
        window.currentUtterance = new SpeechSynthesisUtterance(text);
        
        const voices = window.speechSynthesis.getVoices();
        let preferredVoice = null;
        preferredVoice = voices.find(v => v.name === 'Google US English');
        if (!preferredVoice) preferredVoice = voices.find(v => v.name.includes('Zira'));
        if (!preferredVoice) preferredVoice = voices.find(v => v.name.includes('Female'));

        if (preferredVoice) window.currentUtterance.voice = preferredVoice;
        
        window.currentUtterance.pitch = 1.0; 
        window.currentUtterance.rate = 1.0;  
        
        isSpeaking = true;
        shouldRestart = true; // Ensure we know to restart after this
        
        // Event: Start Speaking
        window.currentUtterance.onstart = () => {
            avatar.classList.add('speaking');
        };
        
        // Event: Finished Speaking -> Resume Listening
        window.currentUtterance.onend = () => {
             isSpeaking = false;
             avatar.classList.remove('speaking');
             statusText.textContent = "Finished speaking...";
             
             // Important: Resume Loop
             if (shouldRestart) {
                 statusText.textContent = "Listening again...";
                 setTimeout(startRecognition, 500); // Short pause before mic opens
             }
        };
        
        // Handle Error (e.g. if speech canceled)
        window.currentUtterance.onerror = () => {
            isSpeaking = false;
            avatar.classList.remove('speaking');
            if(shouldRestart) startRecognition();
        };
        
        window.speechSynthesis.speak(window.currentUtterance);
    }
    
    window.speechSynthesis.getVoices();
</script>
{% endblock %}
