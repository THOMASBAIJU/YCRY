{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto py-10" data-aos="fade-up">
    
    <!-- Hero Header -->
    <div class="relative rounded-[2.5rem] overflow-hidden mb-10 h-64 shadow-2xl" data-aos="fade-down">
         <img src="{{ url_for('static', filename='images/nutrition_landing.png') }}" 
              class="absolute inset-0 w-full h-full object-cover" alt="Nutrition">
         <div class="absolute inset-0 bg-orange-900/40 mix-blend-multiply"></div>
         <div class="absolute inset-0 flex flex-col items-center justify-center text-center p-6 text-white">
             <h1 class="text-4xl md:text-5xl font-display font-extrabold mb-2 text-shadow">My Nutrition ü•ï</h1>
             <p class="text-orange-50 text-lg">Feeding guide for <span class="text-white font-bold">{{ baby_name }}</span> ({{ age }} months)</p>
         </div>
    </div>

    <!-- AI Tools Grid -->
    <div class="grid md:grid-cols-2 gap-6 mb-12">
        
        <!-- 1. Food Safety Checker -->
        <div class="glass-premium p-6 relative overflow-hidden group hover:scale-[1.02] transition-transform">
            <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">üçé</div>
            <h3 class="text-xl font-bold text-warm-dark mb-4">Can I Eat This?</h3>
            <div class="flex gap-2 mb-4">
                <input type="text" id="foodInput" placeholder="e.g. Honey, Strawberry..." class="input-premium flex-1">
                <button onclick="checkFood()" id="btnCheck" class="btn-primary px-4">Check</button>
            </div>
            <!-- Result Box -->
            <div id="checkResult" class="hidden p-4 rounded-xl bg-gray-50 text-sm border border-gray-100">
                <p class="font-bold mb-1" id="checkStatus">Loading...</p>
                <p id="checkDesc" class="text-gray-600 text-xs">...</p>
            </div>
        </div>

        <!-- 2. Meal Planner -->
        <div class="glass-premium p-6 relative overflow-hidden group hover:scale-[1.02] transition-transform">
            <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">ü•ó</div>
            <h3 class="text-xl font-bold text-warm-dark mb-4">Smart Meal Planner</h3>
            <p class="text-sm text-warm-gray mb-4">Get a varied, age-appropriate 1-day menu for {{ baby_name }}.</p>
            <button onclick="generateMealPlan()" id="btnPlan" class="btn-secondary w-full justify-center">
                ‚ú® Generate Daily Plan
            </button>
        </div>
    </div>

    <!-- Meal Plan Result (Full Width) -->
    <div id="planResult" class="hidden glass-premium p-8 mb-12 border-orange-200 bg-orange-50/30">
        <h3 class="text-xl font-bold text-orange-800 mb-6 flex items-center gap-2">
            <span>üçΩÔ∏è</span> Today's Menu
        </h3>
        <div id="planContent" class="grid md:grid-cols-3 gap-6">
            <!-- Filled by JS -->
        </div>
    </div>

    <!-- Main Guide Card -->
    <div class="glass-premium p-8 md:p-12 relative overflow-hidden mb-12">
        <div class="absolute top-0 right-0 bg-warm-yellow text-white font-bold py-2 px-6 rounded-bl-2xl shadow-md">
            Stage: {{ guide.title }}
        </div>

        <h2 class="text-2xl font-bold text-warm-dark mb-6">Daily Schedule</h2>
        <div class="flex items-center gap-4 bg-white/50 p-4 rounded-xl border border-white/50 mb-8">
            <span class="text-3xl">‚è∞</span>
            <p class="text-lg font-medium text-warm-gray">{{ guide.schedule }}</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            <!-- Allowed Foods -->
            <div>
                <h3 class="font-bold text-green-600 mb-4 flex items-center gap-2">
                    <span class="bg-green-100 p-2 rounded-full">‚úÖ</span> Allowed Foods
                </h3>
                <ul class="space-y-3">
                    {% for item in guide.allowed %}
                    <li class="flex items-center justify-between bg-green-50/50 p-3 rounded-xl border border-green-100 group">
                        <div class="flex items-center gap-3">
                            <span class="w-2 h-2 rounded-full bg-green-400"></span>
                            <span class="text-gray-700 font-medium">{{ item }}</span>
                        </div>
                        <button onclick="getRecipe('{{ item }}')" class="opacity-0 group-hover:opacity-100 transition-opacity text-[10px] bg-white border border-green-200 text-green-600 px-2 py-1 rounded shadow-sm hover:bg-green-50">
                            Recipe üë®‚Äçüç≥
                        </button>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Avoid Foods -->
            <div>
                <h3 class="font-bold text-red-500 mb-4 flex items-center gap-2">
                    <span class="bg-red-100 p-2 rounded-full">üö´</span> Avoid (For Now)
                </h3>
                <ul class="space-y-3">
                    {% for item in guide.avoid %}
                    <li class="flex items-center gap-3 bg-red-50/50 p-3 rounded-xl border border-red-100">
                        <span class="w-2 h-2 rounded-full bg-red-400"></span>
                        <span class="text-gray-700 font-medium">{{ item }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Recipe Modal -->
    <div id="recipeModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] max-w-lg w-full p-8 relative shadow-2xl transform transition-all scale-95 opacity-0" id="recipeModalContent">
            <button onclick="closeRecipe()" class="absolute top-4 right-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200">‚úï</button>
            <div id="recipeBody">
                <!-- Content here -->
            </div>
        </div>
    </div>

</div>

<script>
    // 1. Check Food Safety
    function checkFood() {
        const query = document.getElementById('foodInput').value;
        if(!query) return;
        
        const btn = document.getElementById('btnCheck');
        const resBox = document.getElementById('checkResult');
        const status = document.getElementById('checkStatus');
        const desc = document.getElementById('checkDesc');
        
        btn.disabled = true;
        btn.innerHTML = '...';
        resBox.classList.remove('hidden');
        status.innerHTML = 'Analyzing...';
        resBox.className = 'p-4 rounded-xl bg-gray-50 text-sm border border-gray-100 mt-2';
        
        fetch('/api/nutrition_ai', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'check_safety', query: query})
        })
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = 'Check';
            
            if(data.error) {
                status.innerText = "Error";
                desc.innerText = data.error;
                return;
            }
            
            // Color Logic
            let colorClass = 'bg-gray-50 border-gray-200';
            let icon = '‚ùì';
            if(data.status.includes('SAFE')) { colorClass = 'bg-green-50 border-green-200 text-green-900'; icon = '‚úÖ'; }
            if(data.status.includes('CAUTION')) { colorClass = 'bg-yellow-50 border-yellow-200 text-yellow-900'; icon = '‚ö†Ô∏è'; }
            if(data.status.includes('UNSAFE') || data.status.includes('AVOID')) { colorClass = 'bg-red-50 border-red-200 text-red-900'; icon = 'üö´'; }
            
            resBox.className = `p-4 rounded-xl text-sm border mt-2 ${colorClass}`;
            status.innerHTML = `${icon} ${data.status}`;
            desc.innerHTML = `<strong>Prep:</strong> ${data.prep}<br><strong>Benefit:</strong> ${data.benefit}`;
        });
    }

    // 2. Generate Meal Plan
    function generateMealPlan() {
        const btn = document.getElementById('btnPlan');
        const resBox = document.getElementById('planResult');
        const content = document.getElementById('planContent');
        
        btn.disabled = true;
        btn.innerHTML = 'Cooking... üç≥';
        resBox.classList.remove('hidden');
        content.innerHTML = '<p class="col-span-3 text-center text-gray-500 py-8">Chef AI is designing the menu...</p>';
        
        fetch('/api/nutrition_ai', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'meal_plan'})
        })
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = '‚ú® Reroll Menu';
            content.innerHTML = '';
            
            if(data.error) {
                content.innerHTML = `<p class="col-span-3 text-center text-red-500">${data.error}</p>`;
                return;
            }
            
            data.forEach(m => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-xl shadow-sm border border-orange-100";
                card.innerHTML = `
                    <h4 class="font-bold text-orange-600 text-xs uppercase tracking-wider mb-2">${m.meal}</h4>
                    <p class="font-bold text-gray-800 text-lg mb-1">${m.food}</p>
                    <p class="text-sm text-gray-500">${m.desc}</p>
                `;
                content.appendChild(card);
            });
        });
    }

    // 3. Get Recipe
    function getRecipe(foodName) {
        const modal = document.getElementById('recipeModal');
        const content = document.getElementById('recipeModalContent');
        const body = document.getElementById('recipeBody');
        
        modal.classList.remove('hidden');
        // Animate in
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
        
        body.innerHTML = `
            <div class="text-center py-12">
                <p class="text-4xl mb-4">üë®‚Äçüç≥</p>
                <p class="text-gray-500">Finding the perfect recipe for ${foodName}...</p>
            </div>
        `;
        
        fetch('/api/nutrition_ai', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'recipe', query: foodName})
        })
        .then(r => r.json())
        .then(data => {
            if(data.error) {
                body.innerHTML = `<p class="text-center text-red-500">${data.error}</p>`;
                return;
            }
            
            const stepsHtml = data.steps.map(s => `<li class="mb-2 text-gray-600">${s}</li>`).join('');
            const ingHtml = data.ingredients.map(i => `<span class="bg-orange-50 text-orange-700 px-3 py-1 rounded-full text-xs font-bold border border-orange-100">${i}</span>`).join('');
            
            body.innerHTML = `
                <h3 class="text-2xl font-display font-bold text-gray-800 mb-2">${data.title}</h3>
                <div class="flex flex-wrap gap-2 mb-6">${ingHtml}</div>
                
                <h4 class="font-bold text-gray-700 mb-3 border-b border-gray-100 pb-2">Instructions</h4>
                <ol class="list-decimal pl-5 space-y-2 marker:text-orange-500 marker:font-bold">
                    ${stepsHtml}
                </ol>
            `;
        });
    }
    
    function closeRecipe() {
        const modal = document.getElementById('recipeModal');
        const content = document.getElementById('recipeModalContent');
        
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 200);
    }
</script>
{% endblock %}
